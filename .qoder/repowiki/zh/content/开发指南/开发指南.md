# 开发指南

<cite>
**本文档引用的文件**
- [BaseEntity.kt](file://model/src/main/kotlin/top/zztech/ainote/model/common/BaseEntity.kt)
- [TenantAware.kt](file://model/src/main/kotlin/top/zztech/ainote/model/common/TenantAware.kt)
- [Note.kt](file://model/src/main/kotlin/top/zztech/ainote/model/Note.kt)
- [NoteRepository.kt](file://repository/src/main/kotlin/top/zztech/ainote/repository/NoteRepository.kt)
- [NoteService.kt](file://service/src/main/kotlin/top/zztech/ainote/service/NoteService.kt)
- [BaseEntityDraftInterceptor.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/interceptor/BaseEntityDraftInterceptor.kt)
- [TenantAwareDraftInterceptor.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/interceptor/TenantAwareDraftInterceptor.kt)
- [TenantProvider.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/TenantProvider.kt)
- [TenantFilterForNonCacheMode.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/filter/TenantFilterForNonCacheMode.kt)
- [application.yml](file://service/src/main/resources/application.yml)
- [build.gradle.kts](file://build.gradle.kts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [添加新功能的完整流程](#添加新功能的完整流程)
4. [自定义拦截器](#自定义拦截器)
5. [禁用多租户功能](#禁用多租户功能)
6. [使用Jimmer高级特性](#使用jimmer高级特性)
7. [清理项目模板](#清理项目模板)

## 简介
本开发指南旨在为开发者提供在 `ainote-server` 项目基础上进行二次开发的详细指导。内容涵盖添加新实体、仓储和REST控制器的完整流程，强调构建时触发KSP代码生成的重要性，并介绍如何自定义拦截器、禁用多租户支持以及利用Jimmer框架的高级功能（如DTO语言和计算属性）。同时提醒开发者清理示例代码以适配实际业务需求。

## 项目结构
本项目采用清晰的多模块架构，各模块职责分离，便于维护与扩展：

```
ainote-server/
├── model/          # 实体定义与公共基类
├── repository/     # 数据访问层（Spring Data风格仓储）
├── runtime/        # 运行时配置（过滤器、拦截器、解析器、缓存）
└── service/        # 服务层与REST控制器
```

模块间依赖关系如下：
- `service → repository → model`
- `service → runtime → model`
- `runtime → repository → model`

这种设计确保了数据模型的统一性，并支持灵活的服务组合与运行时行为定制。

**Section sources**
- [README.md](file://README.md#L14-L32)

## 添加新功能的完整流程
在本项目中添加新功能需遵循以下四步流程，确保类型安全与自动化机制正常工作。

### 第一步：在model模块定义新的实体接口
在 `model/src/main/kotlin/top/zztech/ainote/model/` 目录下创建新的Kotlin接口，继承 `BaseEntity`（若需多租户支持则同时继承 `TenantAware`）。

```kotlin
@Entity
interface YourEntity : BaseEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    val id: Long

    @Key
    val name: String
}
```

该实体将自动继承 `createdTime` 和 `modifiedTime` 审计字段，并由拦截器自动填充时间戳。

**Section sources**
- [BaseEntity.kt](file://model/src/main/kotlin/top/zztech/ainote/model/common/BaseEntity.kt#L7-L29)
- [Note.kt](file://model/src/main/kotlin/top/zztech/ainote/model/Note.kt#L13-L28)

### 第二步：在repository模块创建对应的仓储类
在 `repository/src/main/kotlin/top/zztech/ainote/repository/` 目录下创建仓储类，继承 `AbstractKotlinRepository`，泛型参数为实体类型及其主键类型。

```kotlin
@Repository
class YourEntityRepository(sql: KSqlClient) : AbstractKotlinRepository<YourEntity, Long>(sql)
```

此仓储类将自动获得基本的增删改查能力，并可通过扩展函数添加自定义查询方法。

**Section sources**
- [NoteRepository.kt](file://repository/src/main/kotlin/top/zztech/ainote/repository/NoteRepository.kt#L14-L27)

### 第三步：在service模块实现REST控制器
在 `service/src/main/kotlin/top/zztech/ainote/service/` 目录下创建服务类，使用 `@RestController` 和 `@RequestMapping` 注解暴露REST API。

```kotlin
@RestController
@RequestMapping("/your-entity")
@Transactional
class YourEntityService(
    private val yourEntityRepository: YourEntityRepository
) {
    // 实现具体业务逻辑
}
```

建议在此层处理事务管理、权限校验及业务编排。

**Section sources**
- [NoteService.kt](file://service/src/main/kotlin/top/zztech/ainote/service/NoteService.kt#L25-L31)

### 第四步：运行 `./gradlew build` 触发KSP生成代码
**关键步骤**：每次添加或修改实体后，必须执行以下命令以触发Kotlin Symbol Processing (KSP) 生成必要的类型安全代码（如Draft类、查询DSL等）：

```bash
./gradlew build
```

若使用IDE开发，建议首次构建后再打开项目，或直接运行 `bootRun` 后所有生成类将自动出现。未执行构建将导致编译错误，因生成代码尚未存在。

**Section sources**
- [README.md](file://README.md#L133-L136)
- [build.gradle.kts](file://build.gradle.kts#L1-L7)

## 自定义拦截器
Jimmer支持通过 `DraftInterceptor` 在保存实体前自动修改其属性。如需添加自定义逻辑（如自动填充创建人、状态初始化等），可在 `runtime/interceptor/` 目录下创建新的拦截器类。

示例结构如下：

```kotlin
@Component
class YourCustomDraftInterceptor : DraftInterceptor<YourEntity, YourEntityDraft> {
    override fun beforeSave(draft: YourEntityDraft, original: YourEntity?) {
        if (original == null) {
            draft.status = "ACTIVE"
        }
    }
}
```

此类将自动注册并应用于所有涉及 `YourEntity` 的保存操作。

**Section sources**
- [BaseEntityDraftInterceptor.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/interceptor/BaseEntityDraftInterceptor.kt#L11-L22)
- [TenantAwareDraftInterceptor.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/interceptor/TenantAwareDraftInterceptor.kt#L11-L21)

## 禁用多租户功能
若项目无需多租户支持，可通过以下步骤完全禁用该功能：

1. **从实体中移除 `TenantAware` 接口**：修改所有实体，不再继承 `TenantAware`。
2. **删除租户相关拦截器**：移除 `TenantAwareDraftInterceptor.kt` 文件。
3. **删除租户过滤器**：移除 `TenantFilterForNonCacheMode.kt` 文件。
4. **清理配置文件中的安全定义**：在 `application.yml` 中删除 `securities` 和 `securitySchemes` 中关于 `tenantHeader` 的配置。

完成上述操作后，系统将不再强制检查 `tenant` 请求头，数据隔离逻辑也将失效。

**Section sources**
- [TenantAware.kt](file://model/src/main/kotlin/top/zztech/ainote/model/common/TenantAware.kt#L6-L16)
- [TenantProvider.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/TenantProvider.kt#L8-L15)
- [TenantFilterForNonCacheMode.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/filter/TenantFilterForNonCacheMode.kt#L14-L25)
- [application.yml](file://service/src/main/resources/application.yml#L42-L49)

## 使用Jimmer高级特性
Jimmer框架提供了多种高级功能，可显著提升开发效率与代码质量。

### DTO语言
在 `service/src/main/dto/` 目录下创建 `.dto` 文件，Jimmer将自动生成对应的Kotlin数据类。例如：

```
dto UserDto {
    String name
    String email
    List<Note> notes
}
```

执行构建后，将生成 `UserDto` 类，可用于API响应或请求体，实现前后端类型同步。

**Section sources**
- [account.dto](file://service/src/main/dto/account.dto)
- [file.dto](file://service/src/main/dto/file.dto)
- [log.dto](file://model/src/main/dto/log.dto)

### 计算属性
支持在实体中定义 `@Formula` 或 `@Transient` 属性，用于表示数据库计算字段或运行时动态值。

```kotlin
@Formula("CONCAT(firstName, ' ', lastName)")
val fullName: String
```

此类属性在查询时会被自动计算，无需手动维护。

**Section sources**
- [README.md](file://README.md#L85)

## 清理项目模板
本项目包含示例实体（如 `Note`），在正式开发前建议删除以下文件以保持代码库整洁：

- `model/src/main/kotlin/top/zztech/ainote/model/Note.kt`
- `repository/src/main/kotlin/top/zztech/ainote/repository/NoteRepository.kt`
- `service/src/main/kotlin/top/zztech/ainote/service/NoteService.kt`

删除后重新运行 `./gradlew build` 以清理生成代码。

**Section sources**
- [README.md](file://README.md#L216)