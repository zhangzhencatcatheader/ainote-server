# 生产环境部署

<cite>
**本文档中引用的文件**  
- [application.yml](file://service/src/main/resources/application.yml)
- [App.kt](file://service/src/main/kotlin/top/zztech/ainote/App.kt)
- [JwtSecurityConfig.kt](file://service/src/main/kotlin/top/zztech/ainote/cfg/JwtSecurityConfig.kt)
- [OssConfig.kt](file://service/src/main/kotlin/top/zztech/ainote/cfg/OssConfig.kt)
- [CacheConfig.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/cache/CacheConfig.kt)
- [JwtTokenProvider.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/utility/JwtTokenProvider.kt)
- [TenantProvider.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/TenantProvider.kt)
- [LogAspect.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/aspect/LogAspect.kt)
- [LogService.kt](file://service/src/main/kotlin/top/zztech/ainote/service/LogService.kt)
- [init.sql](file://database/init.sql)
</cite>

## 目录
1. [简介](#简介)
2. [配置激活与环境管理](#配置激活与环境管理)
3. [JVM性能优化](#jvm性能优化)
4. [日志与调试配置调优](#日志与调试配置调优)
5. [敏感配置外部化](#敏感配置外部化)
6. [Docker部署示例](#docker部署示例)
7. [Kubernetes部署配置](#kubernetes部署配置)
8. [监控与分布式追踪](#监控与分布式追踪)
9. [安全加固建议](#安全加固建议)
10. [总结](#总结)

## 简介
本文档提供 ainote-server 服务在生产环境中的完整部署最佳实践指南。基于 `application.yml` 配置文件，详细说明如何通过环境变量激活生产配置、优化JVM参数、调优日志级别、外部化敏感信息，并提供Docker和Kubernetes部署方案。同时涵盖监控、安全加固和健康检查等关键运维实践。

**文档来源**
- [application.yml](file://service/src/main/resources/application.yml#L1-L57)
- [App.kt](file://service/src/main/kotlin/top/zztech/ainote/App.kt#L1-L14)

## 配置激活与环境管理

为确保应用在生产环境中使用正确的配置，必须通过设置 `SPRING_PROFILES_ACTIVE` 环境变量为 `prod` 来激活生产配置。当前配置文件中使用了默认值 `dev`，生产部署时需覆盖此值。

```yaml
spring:
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}
```

建议在部署时通过环境变量明确指定：

```bash
export SPRING_PROFILES_ACTIVE=prod
java -jar ainote-server.jar
```

或在容器化部署中通过 `environment` 字段设置。

**Section sources**
- [application.yml](file://service/src/main/resources/application.yml#L13-L14)

## JVM性能优化

为优化生产环境下的JVM性能，建议配置以下JVM参数：

- **堆内存设置**：根据服务器资源合理分配堆内存，避免频繁GC
- **GC策略选择**：推荐使用G1垃圾收集器以平衡吞吐量与延迟

示例JVM启动参数：

```bash
-Xms2g -Xmx2g \
-XX:+UseG1GC \
-XX:MaxGCPauseMillis=200 \
-XX:+UseStringDeduplication \
-Dspring.profiles.active=prod
```

这些参数可根据实际负载进行调优，建议在预发布环境中进行压力测试以确定最优配置。

## 日志与调试配置调优

### SQL日志控制
当前配置中 `jimmer.show-sql` 设置为 `true`，这在生产环境中会严重影响性能并暴露敏感信息，必须关闭：

```yaml
jimmer:
  show-sql: false
  pretty-sql: false
```

### 调试端点禁用
生产环境中应禁用所有调试和开发用端点。虽然当前代码中未显式暴露敏感端点，但建议通过安全配置限制访问。

### 日志级别调优
建议将日志级别调整为 `INFO` 或 `WARN`，减少不必要的日志输出：

```yaml
logging:
  level:
    top.zztech.ainote: INFO
    org.springframework: WARN
    org.babyfish.jimmer: WARN
```

**Section sources**
- [application.yml](file://service/src/main/resources/application.yml#L28-L29)

## 敏感配置外部化

所有敏感配置必须通过环境变量外部化，禁止在代码或配置文件中硬编码。

### 数据库配置
```yaml
spring:
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:ainote}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}
```

### Redis配置
```yaml
spring:
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
```

### OSS密钥配置
```yaml
aliyun:
  oss:
    endpoint: ${ALIYUN_OSS_ENDPOINT:https://oss-cn-hangzhou.aliyuncs.com}
    access-key-id: ${ALIYUN_ACCESS_KEY_ID:}
    access-key-secret: ${ALIYUN_ACCESS_KEY_SECRET:}
    bucket-name: ${ALIYUN_OSS_BUCKET:}
```

### JWT密钥配置
当前JWT密钥为明文硬编码，存在严重安全风险，必须通过环境变量注入：

```yaml
jwt:
  secret: ${JWT_SECRET:default-secret-key}
  expiration: ${JWT_EXPIRATION:86400000}
```

**Section sources**
- [application.yml](file://service/src/main/resources/application.yml#L2-L22)
- [application.yml](file://service/src/main/resources/application.yml#L55-L57)
- [OssConfig.kt](file://service/src/main/kotlin/top/zztech/ainote/cfg/OssConfig.kt#L22-L54)
- [JwtTokenProvider.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/utility/JwtTokenProvider.kt#L14-L16)

## Docker部署示例

### Dockerfile
```Dockerfile
FROM openjdk:17-jre-slim

WORKDIR /app

COPY build/libs/ainote-server.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-Xms1g", "-Xmx1g", "-XX:+UseG1GC", "-jar", "app.jar"]
```

### 启动命令
```bash
docker run -d \
  --name ainote-server \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e DB_HOST=prod-db.example.com \
  -e DB_USERNAME=prod_user \
  -e DB_PASSWORD=${DB_PASSWORD} \
  -e REDIS_HOST=prod-redis.example.com \
  -e ALIYUN_ACCESS_KEY_ID=${ALIYUN_ACCESS_KEY_ID} \
  -e ALIYUN_ACCESS_KEY_SECRET=${ALIYUN_ACCESS_KEY_SECRET} \
  -e JWT_SECRET=${JWT_SECRET} \
  ainote-server:latest
```

## Kubernetes部署配置

### Deployment配置
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ainote-server
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ainote-server
  template:
    metadata:
      labels:
        app: ainote-server
    spec:
      containers:
      - name: ainote-server
        image: ainote-server:latest
        ports:
        - containerPort: 8080
        envFrom:
        - secretRef:
            name: ainote-secrets
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: prod
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: ainote-config
              key: db.host
        resources:
          requests:
            memory: "2Gi"
            cpu: "500m"
          limits:
            memory: "4Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 15
```

### ConfigMap配置
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: ainote-config
data:
  db.host: "prod-db.example.com"
  redis.host: "prod-redis.example.com"
  oss.endpoint: "https://oss-cn-hangzhou.aliyuncs.com"
```

### Secret配置
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: ainote-secrets
type: Opaque
data:
  DB_PASSWORD: <base64-encoded-password>
  REDIS_PASSWORD: <base64-encoded-password>
  ALIYUN_ACCESS_KEY_ID: <base64-encoded-key-id>
  ALIYUN_ACCESS_KEY_SECRET: <base64-encoded-key-secret>
  JWT_SECRET: <base64-encoded-jwt-secret>
```

**Section sources**
- [application.yml](file://service/src/main/resources/application.yml#L2-L22)
- [application.yml](file://service/src/main/resources/application.yml#L55-L57)

## 监控与分布式追踪

### 健康探针配置
应用已集成Spring Boot Actuator健康检查端点，可通过 `/actuator/health` 进行健康检查。建议在Kubernetes中配置liveness和readiness探针。

### 审计日志监控
系统通过 `LogAspect` 和 `LogService` 实现了完整的操作审计日志功能，记录所有关键操作：

```kotlin
@LogOperation(action = "QUERY_ALL_LOGS", entityType = "Log", includeRequest = false)
@GetMapping
fun findAll(): List<Log> = logRepository.findAll()
```

日志数据存储在 `log` 表中，包含操作类型、用户、IP地址、请求信息等，可用于安全审计和故障排查。

```sql
CREATE TABLE log(
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    account_id UUID,
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50),
    entity_id UUID,
    ip_address VARCHAR(50),
    user_agent VARCHAR(255),
    request_method VARCHAR(10),
    request_url VARCHAR(500),
    response_status INT,
    error_message TEXT,
    created_time TIMESTAMP NOT NULL,
    modified_time TIMESTAMP NOT NULL
);
```

**Section sources**
- [LogAspect.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/aspect/LogAspect.kt#L74-L143)
- [LogService.kt](file://service/src/main/kotlin/top/zztech/ainote/service/LogService.kt#L37-L54)
- [init.sql](file://database/init.sql#L46-L60)

## 安全加固建议

### JWT密钥轮换
当前JWT密钥为静态配置，建议实现密钥轮换机制：

1. 定期更新 `JWT_SECRET` 环境变量
2. 实现多密钥支持，允许新旧密钥同时有效一段时间
3. 使用密钥管理服务（如Hashicorp Vault）管理密钥

### 租户头验证
系统通过 `TenantProvider` 实现多租户支持，从请求头中获取租户信息：

```kotlin
val tenant: String?
    get() = (RequestContextHolder.getRequestAttributes() as? ServletRequestAttributes)
        ?.request
        ?.getHeader("tenant")
        ?.takeIf { it.isNotEmpty() }
```

建议：
- 强制验证租户头存在
- 对租户ID进行格式校验
- 实现租户白名单机制

### CORS安全配置
当前CORS配置允许所有源访问，生产环境中应限制为可信域名：

```kotlin
registry.addMapping("/**")
    .allowedOriginPatterns("https://trusted-domain.com")
    .allowedMethods("*")
    .allowedHeaders("*")
    .allowCredentials(true)
```

### 缓存安全
Redis缓存配置已集成Redisson，建议：
- 为Redis配置访问密码
- 使用专用的Redis实例
- 定期清理过期缓存

**Section sources**
- [TenantProvider.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/TenantProvider.kt#L1-L15)
- [JwtTokenProvider.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/utility/JwtTokenProvider.kt#L1-L50)
- [CorsConfig.kt](file://service/src/main/kotlin/top/zztech/ainote/cfg/CorsConfig.kt#L1-L17)
- [CacheConfig.kt](file://runtime/src/main/kotlin/top/zztech/ainote/runtime/cache/CacheConfig.kt#L1-L58)

## 总结
ainote-server 的生产环境部署需要重点关注配置管理、性能优化、安全加固和监控告警。通过合理设置环境变量激活生产配置，外部化所有敏感信息，优化JVM参数和日志配置，结合Docker和Kubernetes的标准化部署，可确保系统稳定、安全、高效运行。同时，充分利用内置的审计日志和健康检查功能，建立完善的监控体系，为系统的长期运维提供保障。