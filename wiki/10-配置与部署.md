# 配置与部署

## 简介

本文档详细介绍 ainote-server 项目的配置管理和部署方案，包括数据库配置、缓存配置、生产环境部署、Docker 容器化部署、监控配置等多个方面的内容。

## 应用配置

### 核心配置文件

#### application.yml

```yaml
spring:
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:ainote}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}

  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

aliyun:
  oss:
    endpoint: ${ALIYUN_OSS_ENDPOINT:https://oss-cn-hangzhou.aliyuncs.com}
    access-key-id: ${ALIYUN_ACCESS_KEY_ID:}
    access-key-secret: ${ALIYUN_ACCESS_KEY_SECRET:}
    bucket-name: ${ALIYUN_OSS_BUCKET:}

jimmer:
  language: kotlin
  offset-optimizing-threshold: 10
  id-only-target-checking-level: ALL
  database-validation-mode: ERROR
  show-sql: true
  pretty-sql: true

  client:
    ts:
      path: /ts.zip
    openapi:
      path: /openapi.yml
      ui-path: /openapi.html
      properties:
        info:
          title: Ainote Server REST API
          description: Ainote Server REST API Documentation
          version: 1.0.0
        securities:
          - bearerAuth: [ ]
        components:
          securitySchemes:
            bearerAuth:
              type: http
              scheme: bearer
              bearerFormat: JWT
              description: 'JWT认证Token，格式：Bearer {token}'

server:
  port: ${SERVER_PORT:8080}

jwt:
  secret: Nobody likes you, everyone left you. They're all out without you, having fun
  expiration: 86400000
```

### 环境特定配置

#### application-prod.yml

```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 50
      minimum-idle: 10

  data:
    redis:
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 16
          max-idle: 16
          min-idle: 2

server:
  tomcat:
    max-threads: 300
    min-spare-threads: 20

logging:
  level:
    top.zztech.ainote: WARN
    org.springframework.security: ERROR

jimmer:
  show-sql: false
  pretty-sql: false
```

#### application-dev.yml

```yaml
spring:
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
    username: sa
    password:

  h2:
    console:
      enabled: true

jimmer:
  show-sql: true
  pretty-sql: true
  database-validation-mode: NONE

logging:
  level:
    top.zztech.ainote: DEBUG
    org.babyfish.jimmer: DEBUG
```

## 数据库配置

### PostgreSQL 配置

#### 基础配置

```sql
-- 创建数据库
CREATE DATABASE ainote WITH ENCODING 'UTF8';

-- 创建用户
CREATE USER ainote_user WITH PASSWORD 'your_password';

-- 授权
GRANT ALL PRIVILEGES ON DATABASE ainote TO ainote_user;

-- 连接数据库
\c ainote;

-- 创建扩展
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";
```

#### 性能优化配置

```sql
-- 优化 PostgreSQL 配置
-- postgresql.conf 关键配置

# 内存配置
shared_buffers = 256MB
effective_cache_size = 1GB
work_mem = 4MB
maintenance_work_mem = 64MB

# 连接配置
max_connections = 200
listen_addresses = '*'

# 日志配置
log_statement = 'all'
log_duration = on
log_min_duration_statement = 1000

# 检查点配置
checkpoint_completion_target = 0.9
wal_buffers = 16MB
default_statistics_target = 100
```

#### 索引优化

```sql
-- 创建索引优化查询性能
CREATE INDEX CONCURRENTLY idx_account_username ON account(username);
CREATE INDEX CONCURRENTLY idx_account_email ON account(email);
CREATE INDEX CONCURRENTLY idx_account_status ON account(status);

CREATE INDEX CONCURRENTLY idx_note_author_id ON note(author_id);
CREATE INDEX CONCURRENTLY idx_note_tenant ON note(tenant);
CREATE INDEX CONCURRENTLY idx_note_created_time ON note(created_time);

CREATE INDEX CONCURRENTLY idx_static_file_uploaded_by ON static_file(uploaded_by);
CREATE INDEX CONCURRENTLY idx_static_file_tenant ON static_file(tenant);

-- 全文搜索索引
CREATE INDEX CONCURRENTLY idx_note_title_gin ON note USING gin(to_tsvector('chinese', title));
CREATE INDEX CONCURRENTLY idx_note_content_gin ON note USING gin(to_tsvector('chinese', content));
```

### MySQL 配置

#### 基础配置

```sql
-- 创建数据库
CREATE DATABASE ainote CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'ainote_user'@'%' IDENTIFIED BY 'your_password';

-- 授权
GRANT ALL PRIVILEGES ON ainote.* TO 'ainote_user'@'%';
FLUSH PRIVILEGES;
```

#### 性能优化配置

```ini
# my.cnf 配置

[mysqld]
# 基础配置
port = 3306
socket = /var/lib/mysql/mysql.sock
pid-file = /var/run/mysqld/mysqld.pid
user = mysql
bind-address = 0.0.0.0

# 内存配置
innodb_buffer_pool_size = 512M
innodb_log_file_size = 128M
innodb_log_buffer_size = 16M
key_buffer_size = 32M
tmp_table_size = 64M
max_heap_table_size = 64M

# 连接配置
max_connections = 200
max_connect_errors = 1000
wait_timeout = 28800
interactive_timeout = 28800

# 字符集配置
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
init_connect = 'SET NAMES utf8mb4'

# 查询缓存
query_cache_type = 1
query_cache_size = 64M

# 日志配置
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
```

## 缓存配置

### Redis 配置

#### 单机配置

```conf
# redis.conf

# 基础配置
port 6379
bind 127.0.0.1
timeout 300
tcp-keepalive 60

# 内存配置
maxmemory 256mb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000

# AOF 配置
appendonly yes
appendfsync everysec

# 日志配置
loglevel notice
logfile /var/log/redis/redis.log
```

#### 集群配置

```yaml
# application.yml 中配置 Redis 集群
spring:
  data:
    redis:
      cluster:
        nodes:
          - redis-node-1:6379
          - redis-node-2:6379
          - redis-node-3:6379
        max-redirects: 3
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 16
          max-idle: 16
          min-idle: 2
```

### Jimmer 缓存配置

```kotlin
@Configuration
@EnableCaching
class CacheConfig {

    @Bean
    @ConditionalOnProperty(name = ["redis.enabled"], havingValue = "true")
    fun cacheFactory(redissonClient: RedissonClient): CacheFactory<*> {
        return CacheFactory.create(redissonClient) {
            // 远程缓存配置
            withRemoteDuration(Duration.ofHours(1))

            // 本地缓存配置
            withLocalCache(1000, Duration.ofMinutes(10))

            // 软锁防止缓存击穿
            withSoftLock()

            // 缓存跟踪
            withTracking()

            // 租户隔离
            withTenantIsolation()
        }
    }

    @Bean
    @ConditionalOnProperty(name = ["redis.enabled"], havingValue = "false", matchIfMissing = true)
    fun localCacheFactory(): CacheFactory<*> {
        return CacheFactory.create {
            // 仅本地缓存
            withLocalCache(5000, Duration.ofMinutes(30))
            withSoftLock()
        }
    }
}
```

## 生产环境部署

### 系统要求

- **操作系统**: Linux (CentOS 7+, Ubuntu 18.04+)
- **Java**: OpenJDK 17 或更高版本
- **内存**: 最少 2GB，推荐 4GB+
- **磁盘**: 最少 10GB 可用空间
- **网络**: 稳定的网络连接

### 环境准备

#### 1. 安装 Java

```bash
# CentOS/RHEL
sudo yum install -y java-17-openjdk java-17-openjdk-devel

# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y openjdk-17-jdk

# 验证安装
java -version
javac -version
```

#### 2. 创建应用用户

```bash
# 创建应用用户
sudo useradd -r -s /bin/false ainote

# 创建应用目录
sudo mkdir -p /opt/ainote-server
sudo mkdir -p /var/log/ainote-server
sudo mkdir -p /etc/ainote-server

# 设置权限
sudo chown -R ainote:ainote /opt/ainote-server
sudo chown -R ainote:ainote /var/log/ainote-server
sudo chown -R ainote:ainote /etc/ainote-server
```

#### 3. 部署应用

```bash
# 上传应用包
scp service/build/libs/service-1.0.0.jar user@server:/opt/ainote-server/

# 创建配置文件
sudo tee /etc/ainote-server/application-prod.yml > /dev/null <<EOF
spring:
  profiles:
    active: prod
  datasource:
    url: jdbc:postgresql://localhost:5432/ainote
    username: ainote_user
    password: \${DB_PASSWORD}
  data:
    redis:
      host: localhost
      port: 6379

server:
  port: 8080

logging:
  file:
    name: /var/log/ainote-server/ainote-server.log
  level:
    top.zztech.ainote: INFO
EOF

# 创建环境变量文件
sudo tee /etc/ainote-server/.env > /dev/null <<EOF
DB_PASSWORD=your_database_password
JWT_SECRET=your_jwt_secret_key
ALIYUN_ACCESS_KEY_ID=your_oss_access_key
ALIYUN_ACCESS_KEY_SECRET=your_oss_secret_key
ALIYUN_OSS_BUCKET=your_oss_bucket
EOF
```

### Systemd 服务配置

#### 创建服务文件

```bash
sudo tee /etc/systemd/system/ainote-server.service > /dev/null <<EOF
[Unit]
Description=Ainote Server Application
After=network.target postgresql.service redis.service

[Service]
Type=simple
User=ainote
Group=ainote
WorkingDirectory=/opt/ainote-server
EnvironmentFile=/etc/ainote-server/.env
ExecStart=/usr/bin/java -jar service-1.0.0.jar --spring.config.location=classpath:/application.yml,/etc/ainote-server/application-prod.yml
ExecReload=/bin/kill -HUP \$MAINPID
KillMode=mixed
TimeoutStopSec=30
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=ainote-server

# JVM 参数
Environment=JAVA_OPTS="-Xms1g -Xmx2g -XX:+UseG1GC -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=/var/log/ainote-server/"

[Install]
WantedBy=multi-user.target
EOF
```

#### 启动服务

```bash
# 重新加载 systemd
sudo systemctl daemon-reload

# 启用服务
sudo systemctl enable ainote-server

# 启动服务
sudo systemctl start ainote-server

# 查看状态
sudo systemctl status ainote-server

# 查看日志
sudo journalctl -u ainote-server -f
```

### Nginx 反向代理配置

```nginx
# /etc/nginx/sites-available/ainote-server
server {
    listen 80;
    server_name your-domain.com;

    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 反向代理配置
    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # API 文档
    location /openapi.html {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

## Docker 部署

### Dockerfile

```dockerfile
# 多阶段构建
FROM openjdk:17-jdk-slim as builder

WORKDIR /app
COPY . .
COPY settings.gradle.kts build.gradle.kts ./
COPY service/build.gradle.kts ./service/
COPY model/build.gradle.kts ./model/
COPY repository/build.gradle.kts ./repository/
COPY runtime/build.gradle.kts ./runtime/

# 构建应用
RUN ./gradlew :service:bootJar --no-daemon

# 运行时镜像
FROM openjdk:17-jre-slim

# 安装必要的工具
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 创建应用用户
RUN groupadd -r ainote && useradd -r -g ainote ainote

# 设置工作目录
WORKDIR /app

# 复制应用文件
COPY --from=builder /app/service/build/libs/service-*.jar app.jar

# 创建日志目录
RUN mkdir -p /app/logs && chown -R ainote:ainote /app

# 切换用户
USER ainote

# 暴露端口
EXPOSE 8080

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# 启动命令
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  # PostgreSQL 数据库
  postgres:
    image: postgres:15
    container_name: ainote-postgres
    environment:
      POSTGRES_DB: ainote
      POSTGRES_USER: ainote_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - ainote-network
    restart: unless-stopped

  # Redis 缓存
  redis:
    image: redis:7-alpine
    container_name: ainote-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - ainote-network
    restart: unless-stopped

  # Ainote Server 应用
  app:
    build: .
    container_name: ainote-server
    environment:
      SPRING_PROFILES_ACTIVE: prod
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ainote
      DB_USERNAME: ainote_user
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: ${JWT_SECRET}
      ALIYUN_ACCESS_KEY_ID: ${ALIYUN_ACCESS_KEY_ID}
      ALIYUN_ACCESS_KEY_SECRET: ${ALIYUN_ACCESS_KEY_SECRET}
      ALIYUN_OSS_BUCKET: ${ALIYUN_OSS_BUCKET}
    volumes:
      - app_logs:/app/logs
    ports:
      - "8080:8080"
    networks:
      - ainote-network
    depends_on:
      - postgres
      - redis
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: ainote-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    ports:
      - "80:80"
      - "443:443"
    networks:
      - ainote-network
    depends_on:
      - app
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  app_logs:

networks:
  ainote-network:
    driver: bridge
```

### 环境变量文件

```bash
# .env
DB_PASSWORD=your_secure_database_password
JWT_SECRET=your_secure_jwt_secret_key_here
ALIYUN_ACCESS_KEY_ID=your_aliyun_access_key_id
ALIYUN_ACCESS_KEY_SECRET=your_aliyun_access_key_secret
ALIYUN_OSS_BUCKET=your_oss_bucket_name
```

### Docker 部署命令

```bash
# 构建和启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f app

# 扩展应用实例
docker-compose up -d --scale app=3

# 更新应用
docker-compose pull
docker-compose up -d

# 备份数据
docker-compose exec postgres pg_dump -U ainote_user ainote > backup.sql
```

## 监控和日志

### Prometheus 监控配置

```yaml
# prometheus.yml
global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'ainote-server'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 10s
```

### Grafana 仪表板

```json
{
  "dashboard": {
    "title": "Ainote Server 监控",
    "panels": [
      {
        "title": "HTTP 请求率",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{uri}}"
          }
        ]
      },
      {
        "title": "响应时间",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95th percentile"
          }
        ]
      },
      {
        "title": "JVM 内存使用",
        "type": "graph",
        "targets": [
          {
            "expr": "jvm_memory_used_bytes{area=\"heap\"}",
            "legendFormat": "Heap Used"
          }
        ]
      }
    ]
  }
}
```

### 日志聚合

#### ELK Stack 配置

```yaml
# logstash.conf
input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][app] == "ainote-server" {
    json {
      source => "message"
    }

    date {
      match => [ "timestamp", "yyyy-MM-dd HH:mm:ss.SSS" ]
    }

    mutate {
      add_field => { "tenant" => "%{[fields][tenant]}" }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "ainote-server-%{+YYYY.MM.dd}"
  }
}
```

通过以上完整的配置和部署方案，ainote-server 可以在各种环境中稳定运行，并提供完整的监控、日志和运维支持。