# 技术栈与依赖

## 技术栈概览

本项目采用现代化的 JVM 技术栈，以 Kotlin 语言为核心，结合 Spring Boot 构建企业级后端服务。通过 Jimmer ORM 实现类型安全的数据访问，利用 KSP 在编译期生成高效代码，并通过 Redisson 提供分布式缓存支持。整体架构模块化清晰，分为 model、repository、runtime 和 service 四个子项目。

## Kotlin 2.1.20 与 Spring Boot 3.5.6 集成

项目采用 Kotlin 2.1.20 版本，与 Spring Boot 3.5.6 深度集成。Kotlin 的空安全、扩展函数、数据类等特性显著提升了代码可读性和安全性。通过 `kotlin("plugin.spring")` 插件支持，Kotlin 与 Spring 的 AOP、依赖注入等机制无缝协作。JVM 目标版本为 17，确保兼容最新性能优化和语言特性。

在 `runtime` 和 `service` 模块中，通过 Gradle 插件声明引入 Kotlin 与 Spring 支持，确保编译器正确处理注解和代理生成。

## Jimmer ORM 0.9.117 核心优势

Jimmer 作为现代 Kotlin ORM 框架，相比传统 JPA 具有显著优势：

### 类型安全 DSL

Jimmer 提供完全类型安全的查询 DSL，避免运行时 SQL 错误。所有实体关系在编译期验证，IDE 可提供完整代码补全。

### Smart Save

通过 `DraftInterceptor` 机制实现智能保存。例如，`BaseEntityDraftInterceptor` 自动填充 `createdTime` 和 `modifiedTime` 字段，无需在业务代码中手动设置。

### Object Fetcher

支持细粒度对象图获取，避免 N+1 查询问题。可在查询时精确指定需要加载的关联字段，提升性能。

### DTO 语言

从 `.dto` 文件自动生成 DTO，实现前后端类型同步。

### 多租户支持

内置租户隔离功能，通过注解和过滤器自动实现数据隔离。

### 多层缓存

Redis 多层缓存支持，包含本地缓存和远程缓存的协同工作。

### 计算属性

Formula 和 Transient 属性支持数据库计算字段和运行时动态值。

### 全局过滤器

自动查询过滤，简化复杂查询条件。

Jimmer 通过 KSP 在编译期生成类型安全的 API 和实体类，极大提升开发效率和运行时性能。

## Gradle 与 Kotlin Symbol Processing (KSP)

项目使用 Gradle 作为构建系统，通过 `build.gradle.kts` 脚本实现模块化依赖管理。KSP（Kotlin Symbol Processing）在编译期处理注解并生成代码，相比传统 APT 更快且原生支持 Kotlin。

在 `model` 和 `service` 模块中，`ksp("org.babyfish.jimmer:jimmer-ksp")` 声明了 KSP 处理器，用于生成 Jimmer 的类型安全 API。生成的代码路径已配置为 `build/generated/ksp/main/kotlin`，确保 IDE 正确识别。

## 数据库配置与切换

项目默认配置 PostgreSQL，通过 `application.yml` 中的占位符支持多数据库切换。支持 H2、MySQL、PostgreSQL 三种数据库。

### 当前配置

```yaml
spring:
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:ainote}
```

### 切换方法

1. **H2**: 修改 `driver-class-name` 为 `org.h2.Driver`，URL 改为 `jdbc:h2:mem:ainote`
2. **MySQL**: 修改为 `com.mysql.cj.jdbc.Driver` 和对应 JDBC URL
3. **PostgreSQL**: 使用当前配置

数据库连接池由 Spring Boot 自动配置，支持通过环境变量注入连接参数，便于在不同环境间切换。

## Redisson 多层缓存机制

通过 Redisson 提供 Redis 分布式缓存支持，结合 Jimmer 的缓存抽象实现多层缓存策略。`CacheConfig` 配置类定义了本地缓存（Caffeine）与远程 Redis 的联合使用。

缓存策略包括：
- 远程缓存：有效期 1 小时
- 本地缓存：最多 100 条，有效期 5 分钟
- 软锁机制：防止缓存击穿
- 缓存跟踪：自动失效关联数据

## JWT 认证

- **Token 生成**: 使用 JJWT 库生成和验证 JWT Token
- **无状态认证**: Bearer Token 方式，适合分布式部署
- **过期管理**: 可配置 Token 有效期

## 文件存储

集成阿里云 OSS 对象存储服务，支持文件上传、下载和管理：
- **自动配置**: 通过 `OssConfig.kt` 配置连接参数
- **环境变量**: 支持通过环境变量动态配置
- **多环境支持**: 开发、测试、生产环境可使用不同的 OSS 配置

## AI 服务集成

项目集成了多种 AI 服务，提供智能对话和内容生成能力：

### Spring AI 框架

通过 Spring AI 框架统一接入不同的 AI 服务提供商：
- **ChatModel**: 统一的对话模型接口
- **输出转换器**: BeanOutputConverter 支持 JSON 到对象的自动转换
- **提示词工程**: 支持结构化提示词和系统消息

### 通义千问 (Qwen)

使用阿里云通义千问模型：
- **标准模型**: `qwen-plus` 等通用对话模型
- **长文本模型**: `qwen-long` 支持长文档理解和处理
- **文件理解**: 支持上传文件进行内容提取和分析
- **配置**: 通过 `DASHSCOPE_API_KEY` 和 `DASHSCOPE_CHAT_MODEL` 配置

### OpenAI 集成

支持 OpenAI GPT 系列模型：
- **兼容性**: 使用 OpenAI Java SDK
- **灵活性**: 可切换不同的 GPT 模型版本
- **配置**: 通过 `OPENAI_API_KEY` 配置

### AI 应用场景

- **智能对话**: `/ai/chat` 接口提供基础对话能力
- **模板生成**: `/ai/template-fields` 接口根据文档自动生成台账模板字段
- **结构化输出**: AI 输出自动转换为强类型对象

## 短信验证服务

集成阿里云号码认证服务（PNVS）：
- **验证码发送**: 发送短信验证码到用户手机
- **验证码校验**: 验证用户输入的验证码是否正确
- **防刷机制**: 支持最小发送间隔配置
- **有效期管理**: 验证码有效期可配置
- **场景支持**: 支持注册、登录等多种验证场景
- **Hutool Captcha**: 集成图形验证码，防止机器人恶意调用

### 短信配置

通过环境变量配置阿里云短信服务：
- `ALIYUN_PNVS_SMS_REGION`: 服务区域
- `ALIYUN_PNVS_SMS_ENDPOINT`: 服务端点
- `ALIYUN_PNVS_ACCESS_KEY_ID`: 访问密钥 ID
- `ALIYUN_PNVS_ACCESS_KEY_SECRET`: 访问密钥 Secret
- `ALIYUN_PNVS_SMS_SIGN_NAME`: 短信签名
- `ALIYUN_PNVS_SMS_TEMPLATE_CODE`: 短信模板代码
- `ALIYUN_PNVS_SMS_CODE_LENGTH`: 验证码长度
- `ALIYUN_PNVS_SMS_VALID_TIME_SECONDS`: 验证码有效期
- `ALIYUN_PNVS_SMS_MIN_SEND_INTERVAL_SECONDS`: 最小发送间隔

## 核心依赖列表

| 依赖 | 版本 | 作用 |
|------|------|------|
| Kotlin | 2.1.20 | 主要编程语言 |
| Spring Boot | 3.5.6 | 应用框架与自动配置 |
| Jimmer ORM | 0.9.117 | 类型安全的 Kotlin ORM |
| KSP | 2.1.20-2.0.0 | Kotlin 编译期代码生成 |
| Redisson | 3.52.0 | Redis 客户端与分布式缓存 |
| PostgreSQL Driver | 42.7.4 | 数据库连接驱动 |
| JJWT | 0.12.6 | JWT 令牌生成与验证 |
| Aliyun OSS SDK | 3.18.1 | 对象存储服务集成 |
| Aliyun PNVS SMS | 2.0.0 | 阿里云短信验证码服务 |
| Caffeine | 2.9.1 | 本地缓存实现 |
| BCrypt | Spring Security 内置 | 密码加密 |
| Hutool Captcha | 5.8.42 | 图形验证码生成 |
| Spring AI BOM | 1.0.0 | Spring AI 框架依赖管理 |
| Spring AI Alibaba | 1.0.0-M6.1 | 阿里云通义千问集成 |
| OpenAI Java | 4.12.0 | OpenAI GPT 模型集成 |
| dotenv-kotlin | 6.4.1 | 环境变量加载 |

所有依赖版本通过根项目的 `build.gradle.kts` 统一管理，确保版本一致性。

## 版本管理

项目采用统一的版本管理策略：
- 根项目 `build.gradle.kts` 定义全局版本变量
- 各子模块通过 `by rootProject.extra` 引用版本
- 确保模块间依赖版本一致，避免冲突

这种集中式版本管理简化了依赖升级过程，提高了项目的可维护性。