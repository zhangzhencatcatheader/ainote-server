# 快速开始

## 简介

本指南面向首次接触 ainote-server 的开发者，帮助你在本地快速搭建并运行项目。你将学会：
- 环境准备：JDK 17+ 与 Gradle 8.x（推荐使用项目自带 wrapper）
- 首次设置的两种方式：先构建再打开 IDE，或直接在 IDE 中打开后运行 main 方法自动触发代码生成
- 启动应用：使用 Gradle 子模块任务或 IDE 直接运行 main
- 访问 API 文档与客户端生成：Swagger UI、OpenAPI 规范、TypeScript 客户端
- 生产构建与运行：打包为可执行 JAR 并通过 java -jar 启动
- 常见问题与 IDE 报错处理建议

## 环境要求

- **JDK**: 17 或更高版本
- **Gradle**: 8.x（推荐使用项目自带的 wrapper）
- **IDE**: IntelliJ IDEA（推荐）

## 项目结构

ainote-server 采用多模块架构，职责清晰分离：
- model：实体定义与公共基类
- repository：数据访问层（Spring Data 风格仓储）
- runtime：运行时配置（过滤器、拦截器、缓存等）
- service：服务层与 REST 控制器

模块依赖关系如下：
- service → repository → model
- service → runtime → model
- runtime → repository → model

## 核心组件

- **应用入口**：Spring Boot 启动类位于 service 模块，包含主函数与注解，负责加载应用上下文。
- **配置中心**：application.yml 提供数据库、Redis、Jimmer 客户端、OpenAPI/Swagger、服务器端口等配置项。
- **数据初始化**：init.sql 提供开发阶段的数据库表结构与初始数据，便于快速验证。

## 首次设置

首次在 IntelliJ IDEA 中打开此项目时，部分生成代码可能尚不存在。您有两种选择：

### 方式一：先构建再打开

```bash
./gradlew build
# 然后在 IntelliJ IDEA 中打开项目
```

适合希望 IDE 一次性具备完整索引与生成代码的场景。

### 方式二：直接打开后运行

1. 在 IntelliJ IDEA 中打开项目
2. 暂时忽略 IDE 报错
3. 等待依赖下载完成
4. 直接运行 main 方法 - 所有错误将自动消失

## 启动应用

### 使用 Gradle

```bash
./gradlew :service:bootRun
```

### 使用 IDE

在 IDE 中直接运行 `service/src/main/kotlin/top/zztech/ainote/App.kt` 中的 `main` 函数。

应用将启动在 `http://localhost:8080`

## 访问 API 文档

应用启动后，可访问：

- **Swagger UI**: http://localhost:8080/openapi.html
- **OpenAPI 规范**: http://localhost:8080/openapi.yml
- **TypeScript 客户端**: http://localhost:8080/ts.zip

**认证**: API 请求需要在 Header 中添加 JWT Token:
```bash
curl -H "Authorization: Bearer {token}" http://localhost:8080/api/endpoint
```

## 数据库与缓存配置

### 数据库配置

项目默认使用 PostgreSQL，可通过环境变量或 application.yml 配置：

```bash
export DB_HOST=localhost
export DB_PORT=5432
export DB_NAME=ainote
export DB_USERNAME=postgres
export DB_PASSWORD=your_password
```

或直接修改 `application.yml`：
```yaml
spring:
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://localhost:5432/ainote
    username: postgres
    password: your_password
```

### 缓存配置（可选）

启用 Redis 缓存：

```bash
export REDIS_HOST=localhost
export REDIS_PORT=6379
export REDIS_PASSWORD=  # 如果有密码
```

或修改 `application.yml`：
```yaml
spring:
  redis:
    host: localhost
    port: 6379
    password:  # 如果需要
```

重启应用后生效。

## 生产构建与运行

### 生产构建

```bash
./gradlew clean build
```

可执行 JAR 将生成在 `service/build/libs/`

### 生产运行

```bash
java -jar service/build/libs/service-1.0.0.jar \
  -Dspring.profiles.active=prod \
  -DDB_HOST=your-db-host \
  -DDB_PORT=5432 \
  -DDB_NAME=ainote \
  -DDB_USERNAME=postgres \
  -DDB_PASSWORD=your_password
```

## 常见问题排查

### IDE 报错处理

- 若首次打开项目出现 IDE 报错，请优先尝试"先构建再打开"的方式，确保生成代码与依赖就绪
- 若选择"直接在 IDE 中打开"，等待依赖下载完成后，直接运行 main 方法，通常可自动修复大部分临时性报错

### 端口冲突

- 默认端口为 8080，若被占用可在配置文件中调整端口后再启动

### 数据库连接失败

- 确认数据库驱动与连接信息正确；如使用内存数据库，无需额外配置

### 缓存未生效

- 如启用 Redis，请确认 Redis 服务已启动且配置正确

## 性能考虑

- 使用项目自带 Gradle wrapper 可减少环境差异带来的构建问题
- 在开发阶段使用内存数据库可提升启动速度；生产环境建议使用稳定的关系型数据库
- 如启用缓存，合理配置 Redis 参数以获得更好的读写性能

## 多租户使用

在 HTTP 请求中添加 `tenant` 头实现租户隔离：

```bash
curl -H "tenant: a" http://localhost:8080/note
```

可用租户: `a`, `b` (可配置)

## 结论

通过本指南，你可以快速完成 ainote-server 的本地搭建与运行。建议优先使用项目自带的 Gradle wrapper，并按"先构建再打开"的方式确保 IDE 与生成代码的完整性。启动后即可访问 Swagger UI、OpenAPI 规范与 TypeScript 客户端，满足前后端联调与自动化集成需求。生产构建与运行步骤简单明确，便于部署上线。